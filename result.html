<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

    <div class="container mt-5">
        <h2 class="text-center">Exam Results</h2>
        <div id="results-table"></div>
    </div>

    <script>
        window.onload = function () {
            const loggedIn = localStorage.getItem("loggedIn");
            const role = localStorage.getItem("role");
            const userId = localStorage.getItem("userId");

            if (!loggedIn || role !== "student") {
                window.location.href = "login.html";
                return;
            }

            fetch(`http://localhost:5000/student/${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById("results-table").innerHTML = `<p>${data.error}</p>`;
                    } else {
                        let marks = data.marks ? data.marks.split(', ') : [];
                        let attendance = data.attendance_per_subject ? data.attendance_per_subject.split(', ') : [];

                        let marksMap = {};
                        marks.forEach(mark => {
                            let [subjectExam, score] = mark.split(': ');
                            let [subject, examType] = subjectExam.split(' (');
                            examType = examType.replace(')', '');
                            if (!marksMap[subject]) marksMap[subject] = {};
                            marksMap[subject][examType] = score;
                        });

                        let attendanceMap = {};
                        attendance.forEach(att => {
                            let [subject, count] = att.split(':');
                            attendanceMap[subject] = count;
                        });

                        let subjects = new Set([...Object.keys(marksMap), ...Object.keys(attendanceMap)]);

                        let tableHtml = `
                            <table class="table table-bordered mt-3">
                                <thead>
                                    <tr>
                                        <th>Subject</th>
                                        <th>Midterm Marks</th>
                                        <th>Final Marks</th>
                                        <th>Attendance</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                        subjects.forEach(subject => {
                            let midterm = marksMap[subject] && marksMap[subject]['Midterm'] ? marksMap[subject]['Midterm'] : 'N/A';
                            let final = marksMap[subject] && marksMap[subject]['Final'] ? marksMap[subject]['Final'] : 'N/A';
                            let att = attendanceMap[subject] ? attendanceMap[subject] : '0';
                            tableHtml += `
                                <tr>
                                    <td>${subject}</td>
                                    <td>${midterm}</td>
                                    <td>${final}</td>
                                    <td>${att} days</td>
                                </tr>`;
                        });

                        tableHtml += `
                                </tbody>
                            </table>`;

                        document.getElementById("results-table").innerHTML = tableHtml;
                    }
                })
                .catch(error => console.error("Error:", error));
        };
    </script>

</body>

</html>
